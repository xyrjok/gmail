<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail 管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/all.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 250px;
            --primary-blue: #007bff;
        }
        body { font-size: 0.9rem; background-color: #f8f9fa; overflow-x: hidden; }
        
        /* 提示内容样式 */
        ::placeholder { color: #cccccc !important; opacity: 1; }
        .text-muted { color: #cccccc !important; }
        .form-text { color: #cccccc !important; }

        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 0.4rem 0.6rem;
        }
        .form-control:focus, .form-select:focus {
            border: 1px solid var(--primary-blue);
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
            outline: none;
        }
        
        /* 侧边栏布局 */
        #sidebar-wrapper {
            min-height: 100vh;
            margin-left: -var(--sidebar-width);
            transition: margin .25s ease-out;
            background: #343a40;
            color: #fff;
            position: fixed;
            width: var(--sidebar-width);
            z-index: 1000;
        }
        #sidebar-wrapper .list-group-item {
            background-color: transparent;
            color: #ccc;
            border: none;
            padding: 1rem 1.5rem;
        }
        
        /* 修改点：侧边栏选中状态改为灰色 (与鼠标悬停一致)，覆盖 Bootstrap 默认蓝色 */
        #sidebar-wrapper .list-group-item:hover, #sidebar-wrapper .list-group-item.active {
            background-color: rgba(255,255,255,0.1) !important;
            color: #fff !important;
            border-color: transparent !important;
        }
        
        #page-content-wrapper { width: 100%; padding-left: var(--sidebar-width); }
        .content-section { display: none; padding: 20px; }
        .content-section.active { display: block; }

        /* 修改点：页面右边标题改小 */
        .content-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem !important;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        /* 收件箱分栏 */
        .split-view { display: flex; height: calc(100vh - 60px); }
        .col-c { width: 300px; border-right: 1px solid #dee2e6; overflow-y: auto; background: #fff; }
        .col-d { flex: 1; padding: 20px; overflow-y: auto; background: #fff; }
        .email-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .email-item:hover { background-color: #f1f1f1; }
        
        /* 登录遮罩 */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }

        .text-truncate-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* 修改点：优化 API 配置列的显示，防止内容过长撑爆表格 */
        .api-config-cell {
            font-size: 0.75rem;
            max-width: 200px;
            word-break: break-all;
            white-space: pre-wrap;
            color: #666;
        }
        
        .cursor-pointer { cursor: pointer; }
        .cursor-pointer:hover { color: var(--primary-blue); }

        /* 鼠标跟随 Toast 样式 */
        #mouse-toast {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        /* 邮箱列表选中样式优化 */
        #inbox-account-list .list-group-item.active {
            background-color: #e9ecef;
            color: #000;
            border-left: 4px solid var(--primary-blue);
            padding-left: calc(1rem - 4px); /* 保持内容对齐 */
        }
    </style>
</head>
<body>

    <div id="mouse-toast"></div>

    <div id="login-overlay">
        <div class="card p-4 shadow" style="width: 350px;">
            <h4 class="text-center mb-3">系统登录</h4>
            <input type="text" id="admin-user" class="form-control mb-2" placeholder="用户名">
            <input type="password" id="admin-pass" class="form-control mb-3" placeholder="密码 (回车登录)">
            <button class="btn btn-primary w-100" onclick="doLogin()">登录</button>
        </div>
    </div>

    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-heading text-center py-4 fs-4 border-bottom border-secondary">
                <i class="fas fa-mail-bulk"></i> Gmail Manager
            </div>
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action active" onclick="showSection('section-accounts')"><i class="fas fa-users-cog me-2"></i> 邮箱管理</a>
                <a href="#" class="list-group-item list-group-item-action" onclick="showSection('section-send')"><i class="fas fa-paper-plane me-2"></i> 发件设置</a>
                <a href="#" class="list-group-item list-group-item-action" onclick="showSection('section-receive')"><i class="fas fa-inbox me-2"></i> 收件设置</a>
                <a href="#" class="list-group-item list-group-item-action" onclick="doLogout()"><i class="fas fa-sign-out-alt me-2"></i> 退出登录</a>
            </div>
        </div>

        <div id="page-content-wrapper">
            
            <div id="section-accounts" class="content-section active">
                <h3 class="mb-4">邮箱管理</h3>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="mb-3 d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="openAddModal()"><i class="fas fa-plus"></i> 添加邮箱</button>
                            <button class="btn btn-sm btn-danger" onclick="batchDelAccounts()"><i class="fas fa-trash"></i> 批量删除</button>
                            <div class="ms-auto">
                                <input type="file" id="import-acc-file" style="display:none" onchange="importAccountsFile(this)">
                                <button class="btn btn-sm btn-outline-secondary" onclick="$('#import-acc-file').click()"><i class="fas fa-file-import"></i> 批量导入</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="exportAccounts()"><i class="fas fa-file-export"></i> 批量导出</button>
                            </div>
                        </div>
                        
                        <table class="table table-hover table-sm align-middle">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-acc" onchange="toggleAll('acc')"></th>
                                    <th>名称</th>
                                    <th>别名</th>
                                    <th style="width: 25%">API 配置 (ID/Secret/Token)</th>
                                    <th style="width: 20%">GAS URL</th>
                                    <th>类型</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="account-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-send" class="content-section">
                <h3 class="mb-4">发件设置 & 循环任务</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-white" id="task-card-title">创建任务 / 立即发送</div>
                            <div class="card-body">
                                <input type="hidden" id="edit-task-id">
                                
                                <label class="form-label text-muted small">发件邮箱</label>
                                <input class="form-control mb-2" list="account-list-options" id="send-account-input" placeholder="输入名称搜索或点击选择...">
                                <datalist id="account-list-options"></datalist>
                                
                                <label class="form-label text-muted small">收件人 (多个用逗号分隔)</label>
                                <input type="text" class="form-control mb-2" id="send-to" placeholder="user@example.com">
                                
                                <label class="form-label text-muted small">发送主题</label>
                                <input type="text" class="form-control mb-2" id="send-subject" placeholder="不填默认: Remind">

                                <label class="form-label text-muted small">发送内容</label>
                                <textarea class="form-control mb-2" id="send-content" rows="3" placeholder="不填默认: Reminder of current time + 时间"></textarea>
                                
                                <hr>
                                <label class="form-label fw-bold text-muted small">定时与循环设置</label>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <label class="small text-muted">起始日期</label>
                                        <input type="datetime-local" class="form-control" id="date-a">
                                    </div>
                                    <div class="col-6">
                                        <label class="small text-muted">随机天数 (10-20)</label>
                                        <input type="text" class="form-control" id="range-b" placeholder="10-20">
                                    </div>
                                </div>
                                
                                <div class="mb-3 d-flex align-items-center flex-wrap">
                                    <div class="form-check form-switch me-4">
                                        <input class="form-check-input" type="checkbox" id="loop-switch">
                                        <label class="form-check-label small text-muted" for="loop-switch">循环</label>
                                    </div>
                                    
                                    <div class="d-flex align-items-center gap-2 border-start ps-3 py-1">
                                        <span class="text-muted small">模式:</span>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="radio" name="pref-mode" id="pref-auto" checked>
                                            <label class="form-check-label small text-muted" for="pref-auto">自动</label>
                                        </div>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="radio" name="pref-mode" id="pref-api">
                                            <label class="form-check-label small text-muted" for="pref-api">API</label>
                                        </div>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="radio" name="pref-mode" id="pref-gas">
                                            <label class="form-check-label small text-muted" for="pref-gas">GAS</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary flex-fill" id="btn-save-task" onclick="saveTask()"><i class="fas fa-clock"></i> 添加任务</button>
                                    <button class="btn btn-secondary flex-fill d-none" id="btn-cancel-edit" onclick="cancelEditTask()">取消</button>
                                    <button class="btn btn-success flex-fill" onclick="sendNow()"><i class="fas fa-paper-plane"></i> 立即发送</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <span>任务队列</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openBatchTaskModal()"><i class="fas fa-file-upload"></i> 批量添加</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="batchDelTasks()"><i class="fas fa-trash"></i> 批量删除</button>
                                </div>
                            </div>
                            <div class="card-body p-0" style="overflow-x: auto;">
                                <table class="table table-sm table-striped m-0">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="check-all-task" onchange="toggleAll('task')"></th>
                                            <th>发件邮箱</th>
                                            <th>主题</th>
                                            <th>下次运行</th>
                                            <th>循环</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-list-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-receive" class="content-section p-0">
                <div class="split-view">
                    <div class="col-c bg-light border-end">
                        <div class="p-3 border-bottom bg-white">
                            <label class="form-label small text-muted mb-2 fw-bold">显示最近邮件数</label>
                            <div class="d-flex gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-sm flex-fill limit-btn" onclick="setLimit(1)">1封</button>
                                <button class="btn btn-outline-primary btn-sm flex-fill limit-btn" onclick="setLimit(2)">2封</button>
                                <button class="btn btn-outline-primary btn-sm flex-fill limit-btn" onclick="setLimit(3)">3封</button>
                                <button class="btn btn-outline-primary btn-sm flex-fill limit-btn" onclick="setLimit(5)">5封</button>
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">自定义</span>
                                <input type="number" class="form-control" id="custom-limit-input" placeholder="输入数量" onchange="setCustomLimit(this.value)">
                            </div>
                        </div>
                        
                        <div class="p-2 text-muted small bg-light border-bottom d-flex justify-content-between align-items-center">
                            <span>邮箱账户列表</span>
                            <span class="badge bg-secondary rounded-pill" id="acc-count-badge">0</span>
                        </div>
                        <div id="inbox-account-list" class="list-group list-group-flush" style="font-size: 0.85rem;"></div>
                    </div>
                    
                    <div class="col-d bg-white">
                        <div id="email-content-view">
                            <div class="text-center mt-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>请在左侧选择邮箱查看邮件</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="addAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="accModalTitle">添加邮箱</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="acc-id">
                    <input type="text" class="form-control mb-2" id="acc-name" placeholder="邮箱名">
                    <input type="text" class="form-control mb-2" id="acc-alias" placeholder="别名">
                    <select class="form-select mb-2" id="acc-type">
                        <option value="GAS">Gmail App (GAS)</option>
                        <option value="API">Gmail API</option>
                    </select>
                    <input type="text" class="form-control mb-2" id="acc-script" placeholder="Script URL 或 Token">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="acc-status" checked>
                        <label class="form-check-label text-muted">启用</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveAccount()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="batchTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量添加任务 (JSON)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">格式: <code>[{"account_id":1, "to_email":"a@b.com", "subject":"Hi", ...}]</code></p>
                    <textarea id="batch-task-json" class="form-control" rows="10" placeholder="在此粘贴 JSON 数组"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitBatchTasks()">提交</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js
"></script>
    <script>
        const API_BASE = "https://gm.xyrj.dpdns.org";
        let cachedAccounts = [];
        let cachedTasks = [];
        let lastMouseX = 0, lastMouseY = 0;
        
        let currentEmailLimit = 0; 
        let currentInboxAccountId = null;

        document.addEventListener('mousemove', (e) => {
            lastMouseX = e.pageX;
            lastMouseY = e.pageY;
        });
        document.addEventListener('click', (e) => {
            lastMouseX = e.pageX;
            lastMouseY = e.pageY;
        });

        function showToast(msg) {
            const el = document.getElementById('mouse-toast');
            el.innerText = msg;
            el.style.left = lastMouseX + 10 + 'px';
            el.style.top = lastMouseY + 10 + 'px';
            el.style.display = 'block';
            requestAnimationFrame(() => el.style.opacity = 1);
            setTimeout(() => {
                el.style.opacity = 0;
                setTimeout(() => el.style.display = 'none', 300);
            }, 2000);
        }
        
        function copyText(text) {
            if (!text || text === 'null' || text === '-') return;
            navigator.clipboard.writeText(text)
                .then(() => showToast("已复制！"))
                .catch(() => showToast("复制失败"));
        }

        function toggleTaskLoop(id, isLoop) {
            const task = cachedTasks.find(t => t.id === id);
            if (!task) return;
            const data = { ...task, is_loop: isLoop };
            fetch(API_BASE + '/api/tasks', { method: 'PUT', headers: getHeaders(), body: JSON.stringify(data) })
                .then(r => r.json()).then(res => {
                    if(res.ok) { showToast("循环状态已更新"); task.is_loop = isLoop; }
                    else { showToast("更新失败: " + res.error); loadTasks(); }
                });
        }
        
        function toggleAccountStatus(id, isActive) {
            const acc = cachedAccounts.find(a => a.id === id);
            if (!acc) return;
            const data = { ...acc, status: isActive };
            fetch(API_BASE + '/api/accounts', { method: 'PUT', headers: getHeaders(), body: JSON.stringify(data) })
                .then(r => r.json()).then(res => {
                    if(res.ok) { showToast(isActive ? "邮箱已启用" : "邮箱已禁用"); acc.status = isActive ? 1 : 0; }
                    else { showToast("更新失败"); loadAccounts(); }
                });
        }
        
        function getSelectedAccountId() {
            const name = $("#send-account-input").val();
            const acc = cachedAccounts.find(a => a.name === name);
            return acc ? acc.id : null;
        }

        $("#admin-pass").on('keypress', function (e) {
            if (e.which === 13) doLogin();
        });

        function doLogin() {
            const u = $("#admin-user").val();
            const p = $("#admin-pass").val();
            const token = btoa(u + ":" + p);
            localStorage.setItem("auth_token", token);
            
            fetch(API_BASE, { headers: { 'Authorization': 'Basic ' + token } })
                .then(res => {
                    if(res.ok) {
                        $("#login-overlay").fadeOut();
                        loadAccounts();
                    } else {
                        showToast("账号或密码错误");
                    }
                }).catch(()=> showToast("连接失败"));
        }

        function getHeaders() {
            return {
                'Authorization': 'Basic ' + localStorage.getItem("auth_token"),
                'Content-Type': 'application/json'
            };
        }

        function doLogout() {
            localStorage.removeItem("auth_token");
            location.reload();
        }

        function showSection(id) {
            $(".content-section").removeClass("active");
            $("#" + id).addClass("active");
            $(".list-group-item").removeClass("active");
            $(event.currentTarget).addClass("active");
            
            if(id === 'section-accounts') loadAccounts();
            if(id === 'section-send') {
                loadAccounts().then(() => loadTasks());
            }
            if(id === 'section-receive') loadInboxAccounts();
        }

        // --- 账户管理 ---
        function loadAccounts() {
            return fetch(API_BASE + '/api/accounts', { headers: getHeaders() })
                .then(r => r.json())
                .then(data => {
                    cachedAccounts = data;
                    let html = '';
                    let optionsHtml = ''; 
                    
                    data.forEach(acc => {
                        const statusSwitch = `
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" ${acc.status ? 'checked' : ''} onchange="toggleAccountStatus(${acc.id}, this.checked)">
                        </div>`;
                        
                        // --- 修改点：处理 API 和 GAS 的显示内容 ---
                        let apiDisplay = '-';
                        let gasDisplay = '-';

                        if (acc.type === 'API') {
                            if (acc.client_id) {
                                // 如果有详细 Auth 信息则显示
                                apiDisplay = `
                                    <div><strong>ID:</strong> ${acc.client_id}</div>
                                    <div><strong>Secret:</strong> ${acc.client_secret ? '******' : '-'}</div>
                                    <div class="text-truncate" style="max-width:150px" title="${acc.refresh_token}"><strong>Token:</strong> ${acc.refresh_token}</div>
                                `;
                            } else {
                                // 兼容旧数据或直接存储在 script_url 的情况
                                apiDisplay = `<span class="text-muted">见 GAS URL 或无数据</span>`;
                            }
                        }

                        if (acc.type === 'GAS') {
                            gasDisplay = `<span class="text-truncate-cell" title="${acc.script_url}" onclick="copyText('${acc.script_url}')">${acc.script_url}</span>`;
                        } else if (acc.type === 'API' && !acc.script_url.includes('Using DB Auth')) {
                             // 如果 API 模式下 script_url 存的是旧的长串 token，也可以显示在这里
                             gasDisplay = `<span class="text-truncate-cell text-muted" title="${acc.script_url}">...</span>`;
                        }
                        // ---------------------------------------

                        html += `<tr>
                            <td><input type="checkbox" class="acc-check" value="${acc.id}"></td>
                            <td class="cursor-pointer fw-bold" onclick="copyText('${acc.name}')">${acc.name}</td>
                            <td class="cursor-pointer" onclick="copyText('${acc.alias}')">${acc.alias || '-'}</td>
                            
                            <td class="api-config-cell">${apiDisplay}</td>
                            
                            <td>${gasDisplay}</td>
                            
                            <td><span class="badge ${acc.type==='API'?'bg-success':'bg-primary'}">${acc.type}</span></td>
                            <td>${statusSwitch}</td>
                            <td>
                                <button class="btn btn-sm btn-light text-primary py-0" onclick="openEditModal(${acc.id})"><i class="fas fa-edit"></i></button> 
                                <button class="btn btn-sm btn-light text-danger py-0" onclick="delAccount(${acc.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                        optionsHtml += `<option value="${acc.name}">别名: ${acc.alias || '-'}</option>`;
                    });
                    
                    $("#account-list-body").html(html);
                    $("#account-list-options").html(optionsHtml);
                });
        }

        function batchDelAccounts() {
            const ids = $(".acc-check:checked").map(function(){return this.value;}).get();
            if(ids.length === 0) return showToast("请先选择");
            if(confirm("确定删除选中邮箱?")) {
                fetch(API_BASE + '/api/accounts?ids=' + ids.join(','), { method: 'DELETE', headers: getHeaders() })
                    .then(() => { showToast("删除成功"); loadAccounts(); });
            }
        }

        function exportAccounts() {
             const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cachedAccounts, null, 2));
             const downloadAnchorNode = document.createElement('a');
             downloadAnchorNode.setAttribute("href", dataStr);
             downloadAnchorNode.setAttribute("download", "accounts_backup.json");
             document.body.appendChild(downloadAnchorNode);
             downloadAnchorNode.click();
             downloadAnchorNode.remove();
        }

        function importAccountsFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    fetch(API_BASE + '/api/accounts', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify(json)
                    }).then(r => r.json()).then(res => {
                        showToast(`导入成功 ${res.count || ''} 条`);
                        loadAccounts();
                    });
                } catch(err) {
                    showToast("文件格式错误");
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        // --- 任务管理 ---
        function getExecutionMode() {
            if ($("#pref-api").is(":checked")) return 'API';
            if ($("#pref-gas").is(":checked")) return 'GAS';
            return 'AUTO';
        }

        function saveTask() {
            const id = $("#edit-task-id").val();
            const accId = getSelectedAccountId();
            if (!accId) { showToast("请填写正确的发件邮箱名称"); return; }

            const data = {
                account_id: accId,
                to_email: $("#send-to").val(),
                subject: $("#send-subject").val(),
                content: $("#send-content").val(),
                base_date: $("#date-a").val(),
                delay_config: $("#range-b").val(),
                is_loop: $("#loop-switch").is(":checked"),
                execution_mode: getExecutionMode()
            };

            const method = id ? 'PUT' : 'POST';
            if(id) data.id = id;

            fetch(API_BASE + '/api/tasks', { method, headers: getHeaders(), body: JSON.stringify(data) }).then(() => {
                showToast(id ? "修改成功" : "添加成功");
                cancelEditTask();
                loadTasks();
            });
        }

        function sendNow() {
            const accId = getSelectedAccountId();
            if(!accId) { showToast("请填写正确的发件邮箱名称"); return; }

            const data = {
                account_id: accId,
                to_email: $("#send-to").val(),
                subject: $("#send-subject").val(),
                content: $("#send-content").val(),
                immediate: true,
                execution_mode: getExecutionMode()
            };
            
            const btn = $(event.target).closest('button');
            const originalHtml = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 发送中...');
            
            fetch(API_BASE + '/api/tasks', { method: 'POST', headers: getHeaders(), body: JSON.stringify(data) })
            .then(r => r.json())
            .then(res => {
                btn.prop('disabled', false).html(originalHtml);
                if(res.ok) showToast("发送成功");
                else showToast("失败: " + (res.error || '未知'));
            })
            .catch(() => {
                btn.prop('disabled', false).html(originalHtml);
                showToast("网络错误");
            });
        }

        function loadTasks() {
            fetch(API_BASE + '/api/tasks', { headers: getHeaders() })
                .then(r => r.json())
                .then(data => {
                    cachedTasks = data;
                    let html = '';
                    data.forEach(task => {
                        let statusColor = task.status === 'success' ? 'text-success' : (task.status === 'error' ? 'text-danger' : 'text-warning');
                        
                        // --- 修改点：状态汉化映射 ---
                        const statusMap = {
                            'pending': '等待中',
                            'success': '成功',
                            'error': '失败',
                            'running': '运行中'
                        };
                        const statusText = statusMap[task.status] || task.status;
                        // -----------------------
                        
                        const acc = cachedAccounts.find(a => a.id == task.account_id);
                        const accName = acc ? acc.name : `<span class="text-muted">ID:${task.account_id} (已删)</span>`;
                        const loopSwitch = `
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" ${task.is_loop ? 'checked' : ''} onchange="toggleTaskLoop(${task.id}, this.checked)">
                        </div>`;
                        
                        html += `<tr>
                            <td><input type="checkbox" class="task-check" value="${task.id}"></td>
                            <td>${accName}</td>
                            <td><span class="text-truncate-cell" title="${task.subject||''}">${task.subject || '-'}</span></td>
                            <td>${new Date(task.next_run_at).toLocaleString()}</td>
                            <td>${loopSwitch}</td>
                            <td class="${statusColor} fw-bold">${statusText}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary py-0" title="执行" onclick="manualRun(${task.id})"><i class="fas fa-play"></i></button>
                                <button class="btn btn-sm btn-outline-secondary py-0" title="编辑" onclick="editTask(${task.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger py-0" title="删除" onclick="delTask(${task.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    $("#task-list-body").html(html);
                });
        }

        function editTask(id) {
            const task = cachedTasks.find(t => t.id === id);
            if(!task) return;
            $("#edit-task-id").val(task.id);
            const acc = cachedAccounts.find(a => a.id == task.account_id);
            $("#send-account-input").val(acc ? acc.name : '');
            $("#send-to").val(task.to_email);
            $("#send-subject").val(task.subject);
            $("#send-content").val(task.content);
            $("#date-a").val(task.base_date ? new Date(task.base_date).toISOString().slice(0,16) : '');
            $("#range-b").val(task.delay_config);
            $("#loop-switch").prop("checked", !!task.is_loop);
            let mode = task.execution_mode || 'AUTO';
            $(`input[name="pref-mode"][id="pref-${mode.toLowerCase()}"]`).prop("checked", true);
            $("#task-card-title").text("编辑任务 (ID: " + id + ")");
            $("#btn-save-task").html('<i class="fas fa-save"></i> 更新任务');
            $("#btn-cancel-edit").removeClass("d-none");
            document.querySelector('.content-section.active').scrollIntoView();
        }

        function cancelEditTask() {
            $("#edit-task-id").val("");
            $("#task-card-title").text("创建任务 / 立即发送");
            $("#btn-save-task").html('<i class="fas fa-clock"></i> 添加任务');
            $("#btn-cancel-edit").addClass("d-none");
            $("#send-account-input").val("");
            $("#send-to").val("");
            $("#send-subject").val("");
            $("#send-content").val("");
        }

        function delTask(id) {
            if(confirm("确定删除任务?")) {
                fetch(API_BASE + '/api/tasks?id=' + id, { method: 'DELETE', headers: getHeaders() })
                    .then(() => { showToast("已删除"); loadTasks(); });
            }
        }
        
        function batchDelTasks() {
            const ids = $(".task-check:checked").map(function(){return this.value;}).get();
            if(ids.length === 0) return showToast("请先选择");
            if(confirm("确定删除选中任务?")) {
                fetch(API_BASE + '/api/tasks?ids=' + ids.join(','), { method: 'DELETE', headers: getHeaders() })
                    .then(() => { showToast("批量删除完成"); loadTasks(); });
            }
        }

        function manualRun(id) {
            if(!confirm("立即执行?")) return;
            fetch(API_BASE + '/api/tasks', { method: 'PUT', headers: getHeaders(), body: JSON.stringify({ id: id, action: 'execute' }) })
                .then(r=>r.json()).then(res=>{
                if(res.ok) { showToast("执行成功"); loadTasks(); }
                else showToast("失败: "+res.error);
            });
        }

        function openBatchTaskModal() {
            new bootstrap.Modal(document.getElementById('batchTaskModal')).show();
        }
        
        function submitBatchTasks() {
            try {
                const json = JSON.parse($("#batch-task-json").val());
                if(!Array.isArray(json)) throw new Error("必须是数组");
                fetch(API_BASE + '/api/tasks', { method: 'POST', headers: getHeaders(), body: JSON.stringify(json) })
                    .then(() => {
                        bootstrap.Modal.getInstance(document.getElementById('batchTaskModal')).hide();
                        showToast("批量添加成功");
                        loadTasks();
                    });
            } catch(e) {
                alert("JSON 格式错误: " + e.message);
            }
        }

        function toggleAll(type) {
            const checked = $("#check-all-" + type).is(":checked");
            $("." + type + "-check").prop("checked", checked);
        }

        function openAddModal() {
            $("#accModalTitle").text("添加邮箱");
            $("#acc-id").val(""); 
            $("#acc-name").val("");
            $("#acc-alias").val("");
            $("#acc-script").val("");
            $("#acc-type").val("GAS");
            $("#acc-status").prop("checked", true);
            new bootstrap.Modal(document.getElementById('addAccountModal')).show();
        }
        function openEditModal(id) {
            const acc = cachedAccounts.find(a => a.id === id);
            if(!acc) return;
            $("#accModalTitle").text("编辑邮箱");
            $("#acc-id").val(acc.id);
            $("#acc-name").val(acc.name);
            $("#acc-alias").val(acc.alias);
            $("#acc-script").val(acc.script_url);
            $("#acc-type").val(acc.type);
            $("#acc-status").prop("checked", acc.status == 1);
            new bootstrap.Modal(document.getElementById('addAccountModal')).show();
        }
        function saveAccount() {
            const id = $("#acc-id").val();
            const data = {
                name: $("#acc-name").val(),
                alias: $("#acc-alias").val(),
                type: $("#acc-type").val(),
                script_url: $("#acc-script").val(),
                status: $("#acc-status").is(":checked")
            };
            const method = id ? 'PUT' : 'POST';
            if(id) data.id = id;
            fetch(API_BASE + '/api/accounts', { method, headers: getHeaders(), body: JSON.stringify(data) })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
                loadAccounts();
            });
        }
        function delAccount(id) {
            if(confirm("删除此邮箱?")) {
                fetch(API_BASE + '/api/accounts?id=' + id, { method: 'DELETE', headers: getHeaders() })
                    .then(loadAccounts);
            }
        }

        // --- 收件箱核心逻辑 (点击即同步) ---
        function setLimit(num) {
            currentEmailLimit = parseInt(num);
            
            $(".limit-btn").removeClass("active");
            $(".limit-btn").each(function() {
                if ($(this).text().includes(num + "封")) $(this).addClass("active");
            });
            $("#custom-limit-input").val(""); 

            if (currentInboxAccountId) {
                syncAndLoad(); 
            } else {
                showToast("请先在左侧选择一个邮箱");
            }
        }

        function setCustomLimit(val) {
            if (!val || val <= 0) return;
            currentEmailLimit = parseInt(val);
            $(".limit-btn").removeClass("active");
            
            if (currentInboxAccountId) {
                syncAndLoad();
            } else {
                showToast("请先在左侧选择一个邮箱");
            }
        }

        function syncAndLoad() {
            if (!currentInboxAccountId || !currentEmailLimit) return;

            $("#email-content-view").html(`
                <div class="text-center mt-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 text-muted">正在连接 Gmail 同步最新邮件...</p>
                </div>
            `);

            // 1. 发送同步指令
            fetch(API_BASE + '/api/emails', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ account_id: currentInboxAccountId })
            })
            .then(r => r.json())
            .then(res => {
                if (res.ok) {
                    if(res.count > 0) showToast(`收取到 ${res.count} 封新邮件`);
                    // 2. 加载显示
                    fetchEmailsAfterSync(); 
                } else {
                    $("#email-content-view").html(`
                        <div class="text-center mt-5 text-danger">
                            <i class="fas fa-times-circle fa-3x mb-3"></i>
                            <p>同步失败: ${res.error}</p>
                            <button class="btn btn-outline-secondary btn-sm mt-3" onclick="fetchEmailsAfterSync()">
                                尝试加载旧缓存
                            </button>
                        </div>
                    `);
                }
            })
            .catch(err => {
                $("#email-content-view").html(`<div class="text-center mt-5 text-danger"><p>网络错误: ${err.message}</p></div>`);
            });
        }

        function fetchEmailsAfterSync() {
            fetch(`${API_BASE}/api/emails?account_id=${currentInboxAccountId}&limit=${currentEmailLimit}`, { 
                headers: getHeaders() 
            })
            .then(r => r.json())
            .then(data => {
                if (!data || data.length === 0) {
                    $("#email-content-view").html(`
                        <div class="text-center mt-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>暂无邮件</p>
                        </div>`);
                    return;
                }

                let html = `<div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h5 class="m-0">最新收件 (显示 ${data.length} 封)</h5>
                        <small class="text-muted">刚刚更新</small>
                    </div>
                    <div class="list-group">`;
                
                data.forEach(email => {
                    const dateStr = new Date(email.received_at).toLocaleString();
                    html += `
                        <div class="list-group-item list-group-item-action flex-column align-items-start p-3 mb-2 shadow-sm border rounded">
                            <div class="d-flex w-100 justify-content-between mb-2">
                                <h6 class="mb-1 fw-bold text-primary">${email.subject || '(无主题)'}</h6>
                                <small class="text-muted text-nowrap ms-2">${dateStr}</small>
                            </div>
                            <p class="mb-1 text-secondary small">发件人: ${email.sender || '未知'}</p>
                            <div class="mt-2 p-2 bg-light rounded text-break" style="font-size: 0.9rem; white-space: pre-wrap;">${email.body || '(无内容)'}</div>
                        </div>`;
                });
                
                html += `</div></div>`;
                $("#email-content-view").html(html);
            });
        }

        function loadInboxAccounts() {
            if (cachedAccounts.length > 0) {
                renderInboxAccounts(cachedAccounts);
            } else {
                fetch(API_BASE + '/api/accounts', { headers: getHeaders() })
                    .then(r => r.json())
                    .then(data => {
                        cachedAccounts = data;
                        renderInboxAccounts(data);
                    });
            }
        }

        // 修改版：紧凑 + 序号 + 类型标签 + 隐藏别名
        function renderInboxAccounts(accounts) {
            let html = '';
            let index = 1; 
            
            accounts.forEach(acc => {
                if (acc.status) {
                    // 类型标签颜色区分: API为绿色, GAS为蓝色
                    let badgeColor = acc.type === 'API' ? 'bg-success' : 'bg-primary';
                    
                    html += `<a href="#" class="list-group-item list-group-item-action py-2" onclick="selectAccount(${acc.id}, this)">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center text-truncate">
                                <span class="badge bg-light text-secondary border me-2" style="min-width: 25px; padding: 4px 0;">${index}</span>
                                <span class="fw-bold text-truncate" title="${acc.name}">${acc.name}</span>
                            </div>
                            <span class="badge ${badgeColor} ms-1" style="font-size: 0.7em;">${acc.type}</span>
                        </div>
                    </a>`;
                    index++;
                }
            });
            
            if(html === '') html = '<div class="p-3 text-center text-muted small">无可用账号</div>';
            $("#inbox-account-list").html(html);
            $("#acc-count-badge").text(index - 1);
        }

        function selectAccount(accountId, element) {
            currentInboxAccountId = accountId;
            $("#inbox-account-list .list-group-item").removeClass("active");
            $(element).addClass("active");
            
            currentEmailLimit = 0; 
            $(".limit-btn").removeClass("active");
            $("#custom-limit-input").val("");
            
            $("#email-content-view").html(`
                <div class="text-center mt-5 text-muted">
                    <i class="fas fa-hand-pointer fa-3x mb-3"></i>
                    <p>已选中邮箱</p>
                    <p class="small">点击上方 "1封" / "3封" 按钮<br>将自动同步并显示最新邮件</p>
                </div>
            `);
        }

        if(localStorage.getItem("auth_token")) {
            $("#login-overlay").hide();
            loadAccounts();
        }
    </script>
</body>
</html>
