<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮件查询</title>
    <style>
        /* 极简样式：只有字体大小 */
        body { 
            font-size: 16px; 
            font-family: sans-serif; 
            line-height: 1.5; 
            padding: 0 0 2px 0;
            color: #000;
            background: #fff;
        }
    </style>
</head>
<body>

<div class="container" id="app">
    <div class="loading">正在查询...</div>
</div>

<script>
    const WORKER_API = ""; 
    async function fetchEmails() {
        const app = document.getElementById('app');
        const params = new URLSearchParams(window.location.search);
        let code = params.get('code');
        if (!code) {
            const path = window.location.pathname.replace('/', '');
            if (path && path !== 'index.html') code = path;
        }

        if (!code) {
            // 没有查询码 = 查询码错误
            app.innerHTML = '<div class="error-msg">查询码错误！</div>';
            return;
        }

        try {
            const resp = await fetch(`${WORKER_API}/${code}?format=json`);
            
            if (!resp.ok) {
                // 如果是 403 (过期)，显示过期提示；否则 (404等) 显示错误
                if (resp.status === 403) {
                    app.innerHTML = '<div class="error-msg">查询码已过期！</div>';
                } else {
                    app.innerHTML = '<div class="error-msg">查询码错误！</div>';
                }
                return; // 终止执行
            }
            const data = await resp.json();

            if (data.error) {
                app.innerHTML = `<div class="error-msg">${data.error}</div>`;
                return;
            }

            // 3. 渲染页面
            if (data.length === 0) {
                app.innerHTML = '<div class="loading">暂无符合条件的邮件</div>';
                return;
            }

            let html = '';
            data.forEach(mail => {
                // 格式：时间 | 正文
                html += `
                <div class="row">
                    ${mail.received_at} | ${escapeHtml(mail.body)}
                </div>`;
            });
            app.innerHTML = html;

        } catch (err) {
        // 防止覆盖上面的特定提示，这里可以留空或者只提示错误
        if (app.innerHTML.indexOf('查询码') === -1) {
                 app.innerHTML = '<div class="error-msg">查询码错误！</div>';
            }
        }    
    }

    // 简单的防注入转义
    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/"/g, "&quot;")
                   .replace(/'/g, "&#039;");
    }

    // 启动
    fetchEmails();
</script>

</body>
</html>
