<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail 管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/all.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 250px;
            --primary-blue: #007bff;
        }
        body { font-size: 0.9rem; background-color: #f8f9fa; overflow-x: hidden; }
        
        /* 提示内容样式 */
        ::placeholder { color: #cccccc !important; opacity: 1; }
        .text-muted { color: #cccccc !important; }
        .form-text { color: #cccccc !important; }

        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 0.4rem 0.6rem;
        }
        .form-control:focus, .form-select:focus {
            border: 1px solid var(--primary-blue);
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
            outline: none;
        }
        
        /* 侧边栏布局 */
        #sidebar-wrapper {
            min-height: 100vh;
            margin-left: -var(--sidebar-width);
            transition: margin .25s ease-out;
            background: #343a40;
            color: #fff;
            position: fixed;
            width: var(--sidebar-width);
            z-index: 1000;
        }
        #sidebar-wrapper .list-group-item {
            background-color: transparent;
            color: #ccc;
            border: none;
            padding: 1rem 1.5rem;
        }
        #sidebar-wrapper .list-group-item:hover, .list-group-item.active {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
        }
        #page-content-wrapper { width: 100%; padding-left: var(--sidebar-width); }
        .content-section { display: none; padding: 20px; }
        .content-section.active { display: block; }
        
        /* 收件箱分栏 */
        .split-view { display: flex; height: calc(100vh - 60px); }
        .col-c { width: 300px; border-right: 1px solid #dee2e6; overflow-y: auto; background: #fff; }
        .col-d { flex: 1; padding: 20px; overflow-y: auto; background: #fff; }
        .email-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .email-item:hover { background-color: #f1f1f1; }
        
        /* 登录遮罩 */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }

        .text-truncate-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            vertical-align: middle;
        }
        
        .cursor-pointer { cursor: pointer; }
        .cursor-pointer:hover { color: var(--primary-blue); }

        /* 鼠标跟随 Toast 样式 */
        #mouse-toast {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div id="mouse-toast"></div>

    <div id="login-overlay">
        <div class="card p-4 shadow" style="width: 350px;">
            <h4 class="text-center mb-3">系统登录</h4>
            <input type="text" id="admin-user" class="form-control mb-2" placeholder="用户名">
            <input type="password" id="admin-pass" class="form-control mb-3" placeholder="密码 (回车登录)">
            <button class="btn btn-primary w-100" onclick="doLogin()">登录</button>
        </div>
    </div>

    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-heading text-center py-4 fs-4 border-bottom border-secondary">
                <i class="fas fa-mail-bulk"></i> Gmail Manager
            </div>
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action active" onclick="showSection('section-accounts')"><i class="fas fa-users-cog me-2"></i> 邮箱管理</a>
                <a href="#" class="list-group-item list-group-item-action" onclick="showSection('section-send')"><i class="fas fa-paper-plane me-2"></i> 发件设置</a>
                <a href="#" class="list-group-item list-group-item-action" onclick="showSection('section-receive')"><i class="fas fa-inbox me-2"></i> 收件设置</a>
                <a href="#" class="list-group-item list-group-item-action" onclick="doLogout()"><i class="fas fa-sign-out-alt me-2"></i> 退出登录</a>
            </div>
        </div>

        <div id="page-content-wrapper">
            
            <div id="section-accounts" class="content-section active">
                <h3 class="mb-4">邮箱管理</h3>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="mb-3 d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="openAddModal()"><i class="fas fa-plus"></i> 添加邮箱</button>
                            <button class="btn btn-sm btn-danger" onclick="batchDelAccounts()"><i class="fas fa-trash"></i> 批量删除</button>
                            <div class="ms-auto">
                                <input type="file" id="import-acc-file" style="display:none" onchange="importAccountsFile(this)">
                                <button class="btn btn-sm btn-outline-secondary" onclick="$('#import-acc-file').click()"><i class="fas fa-file-import"></i> 批量导入</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="exportAccounts()"><i class="fas fa-file-export"></i> 批量导出</button>
                            </div>
                        </div>
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-acc" onchange="toggleAll('acc')"></th>
                                    <th>名称</th>
                                    <th>别名</th>
                                    <th>Api/Script URL</th>
                                    <th>类型</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="account-list-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-send" class="content-section">
                <h3 class="mb-4">发件设置 & 循环任务</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-white" id="task-card-title">创建任务 / 立即发送</div>
                            <div class="card-body">
                                <input type="hidden" id="edit-task-id">
                                
                                <label class="form-label text-muted small">发件邮箱</label>
                                <input class="form-control mb-2" list="account-list-options" id="send-account-input" placeholder="输入名称搜索或点击选择...">
                                <datalist id="account-list-options"></datalist>
                                
                                <label class="form-label text-muted small">收件人 (多个用逗号分隔)</label>
                                <input type="text" class="form-control mb-2" id="send-to" placeholder="user@example.com">
                                
                                <label class="form-label text-muted small">发送主题</label>
                                <input type="text" class="form-control mb-2" id="send-subject" placeholder="不填默认: Remind">

                                <label class="form-label text-muted small">发送内容</label>
                                <textarea class="form-control mb-2" id="send-content" rows="3" placeholder="不填默认: Reminder of current time + 时间"></textarea>
                                
                                <hr>
                                <label class="form-label fw-bold text-muted small">定时与循环设置</label>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <label class="small text-muted">起始日期</label>
                                        <input type="datetime-local" class="form-control" id="date-a">
                                    </div>
                                    <div class="col-6">
                                        <label class="small text-muted">随机天数 (10-20)</label>
                                        <input type="text" class="form-control" id="range-b" placeholder="10-20">
                                    </div>
                                </div>
                                
                                <div class="mb-3 d-flex align-items-center flex-wrap">
                                    <div class="form-check form-switch me-4">
                                        <input class="form-check-input" type="checkbox" id="loop-switch">
                                        <label class="form-check-label small text-muted" for="loop-switch">循环</label>
                                    </div>
                                    
                                    <div class="d-flex align-items-center gap-2 border-start ps-3 py-1">
                                        <span class="text-muted small">模式:</span>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="radio" name="pref-mode" id="pref-auto" checked>
                                            <label class="form-check-label small text-muted" for="pref-auto">自动</label>
                                        </div>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="radio" name="pref-mode" id="pref-api">
                                            <label class="form-check-label small text-muted" for="pref-api">API</label>
                                        </div>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="radio" name="pref-mode" id="pref-gas">
                                            <label class="form-check-label small text-muted" for="pref-gas">GAS</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary flex-fill" id="btn-save-task" onclick="saveTask()"><i class="fas fa-clock"></i> 添加任务</button>
                                    <button class="btn btn-secondary flex-fill d-none" id="btn-cancel-edit" onclick="cancelEditTask()">取消</button>
                                    <button class="btn btn-success flex-fill" onclick="sendNow()"><i class="fas fa-paper-plane"></i> 立即发送</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <span>任务队列</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openBatchTaskModal()"><i class="fas fa-file-upload"></i> 批量添加</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="batchDelTasks()"><i class="fas fa-trash"></i> 批量删除</button>
                                </div>
                            </div>
                            <div class="card-body p-0" style="overflow-x: auto;">
                                <table class="table table-sm table-striped m-0">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="check-all-task" onchange="toggleAll('task')"></th>
                                            <th>发件邮箱</th>
                                            <th>主题</th>
                                            <th>下次运行</th>
                                            <th>循环</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-list-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-receive" class="content-section p-0">
                <div class="split-view">
                    <div class="col-c">
                        <div class="p-3 border-bottom text-muted">邮箱列表</div>
                        <div id="inbox-account-list"></div>
                    </div>
                    <div class="col-d">
                        <div id="email-content-view">
                            <p class="text-muted text-center mt-5">请在左侧选择邮箱查看邮件</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="addAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="accModalTitle">添加邮箱</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="acc-id">
                    <input type="text" class="form-control mb-2" id="acc-name" placeholder="邮箱名">
                    <input type="text" class="form-control mb-2" id="acc-alias" placeholder="别名">
                    <select class="form-select mb-2" id="acc-type">
                        <option value="GAS">Gmail App (GAS)</option>
                        <option value="API">Gmail API</option>
                    </select>
                    <input type="text" class="form-control mb-2" id="acc-script" placeholder="Script URL 或 Token">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="acc-status" checked>
                        <label class="form-check-label text-muted">启用</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveAccount()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="batchTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量添加任务 (JSON)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">格式: <code>[{"account_id":1, "to_email":"a@b.com", "subject":"Hi", ...}]</code></p>
                    <textarea id="batch-task-json" class="form-control" rows="10" placeholder="在此粘贴 JSON 数组"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitBatchTasks()">提交</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = "https://gm.xyrj.dpdns.org";
        let cachedAccounts = [];
        let cachedTasks = [];
        let lastMouseX = 0, lastMouseY = 0;

        // 鼠标位置追踪
        document.addEventListener('mousemove', (e) => {
            lastMouseX = e.pageX;
            lastMouseY = e.pageY;
        });
        document.addEventListener('click', (e) => {
            lastMouseX = e.pageX;
            lastMouseY = e.pageY;
        });

        // Toast 提示函数
        function showToast(msg) {
            const el = document.getElementById('mouse-toast');
            el.innerText = msg;
            el.style.left = lastMouseX + 10 + 'px';
            el.style.top = lastMouseY + 10 + 'px';
            el.style.display = 'block';
            
            requestAnimationFrame(() => {
                el.style.opacity = 1;
            });

            setTimeout(() => {
                el.style.opacity = 0;
                setTimeout(() => el.style.display = 'none', 300);
            }, 2000);
        }
        
        // --- 新增: 复制文本功能 ---
        function copyText(text) {
            if (!text || text === 'null' || text === '-') return;
            navigator.clipboard.writeText(text)
                .then(() => showToast("已复制！"))
                .catch(() => showToast("复制失败"));
        }

        // --- 新增: 切换任务循环状态 ---
        function toggleTaskLoop(id, isLoop) {
            const task = cachedTasks.find(t => t.id === id);
            if (!task) return;
            const data = { ...task, is_loop: isLoop };
            fetch(API_BASE + '/api/tasks', { method: 'PUT', headers: getHeaders(), body: JSON.stringify(data) })
                .then(r => r.json()).then(res => {
                    if(res.ok) { showToast("循环状态已更新"); task.is_loop = isLoop; }
                    else { showToast("更新失败: " + res.error); loadTasks(); }
                });
        }
        
        // --- 新增: 切换账户启用状态 ---
        function toggleAccountStatus(id, isActive) {
            const acc = cachedAccounts.find(a => a.id === id);
            if (!acc) return;
            const data = { ...acc, status: isActive };
            fetch(API_BASE + '/api/accounts', { method: 'PUT', headers: getHeaders(), body: JSON.stringify(data) })
                .then(r => r.json()).then(res => {
                    if(res.ok) { showToast(isActive ? "邮箱已启用" : "邮箱已禁用"); acc.status = isActive ? 1 : 0; }
                    else { showToast("更新失败"); loadAccounts(); }
                });
        }
        
        // --- 新增: 从输入框获取 Account ID ---
        function getSelectedAccountId() {
            const name = $("#send-account-input").val();
            const acc = cachedAccounts.find(a => a.name === name);
            return acc ? acc.id : null;
        }

        // 登录回车监听
        $("#admin-pass").on('keypress', function (e) {
            if (e.which === 13) doLogin();
        });

        function doLogin() {
            const u = $("#admin-user").val();
            const p = $("#admin-pass").val();
            const token = btoa(u + ":" + p);
            localStorage.setItem("auth_token", token);
            
            fetch(API_BASE, { headers: { 'Authorization': 'Basic ' + token } })
                .then(res => {
                    if(res.ok) {
                        $("#login-overlay").fadeOut();
                        loadAccounts();
                    } else {
                        showToast("账号或密码错误");
                    }
                }).catch(()=> showToast("连接失败"));
        }

        function getHeaders() {
            return {
                'Authorization': 'Basic ' + localStorage.getItem("auth_token"),
                'Content-Type': 'application/json'
            };
        }

        function doLogout() {
            localStorage.removeItem("auth_token");
            location.reload();
        }

        function showSection(id) {
            $(".content-section").removeClass("active");
            $("#" + id).addClass("active");
            $(".list-group-item").removeClass("active");
            $(event.currentTarget).addClass("active");
            
            // 优化加载顺序: 确保先加载账户，再加载任务(以便显示名称)
            if(id === 'section-accounts') loadAccounts();
            if(id === 'section-send') {
                loadAccounts().then(() => loadTasks());
            }
            if(id === 'section-receive') loadInboxAccounts();
        }

        // --- 账户管理 ---
        function loadAccounts() {
            return fetch(API_BASE + '/api/accounts', { headers: getHeaders() })
                .then(r => r.json())
                .then(data => {
                    cachedAccounts = data;
                    let html = '';
                    let optionsHtml = ''; 
                    
                    data.forEach(acc => {
                        // 状态开关
                        const statusSwitch = `
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" ${acc.status ? 'checked' : ''} onchange="toggleAccountStatus(${acc.id}, this.checked)">
                        </div>`;
                        
                        html += `<tr>
                            <td><input type="checkbox" class="acc-check" value="${acc.id}"></td>
                            <td class="cursor-pointer" onclick="copyText('${acc.name}')" title="点击复制">${acc.name}</td>
                            <td class="cursor-pointer" onclick="copyText('${acc.alias}')" title="点击复制">${acc.alias || '-'}</td>
                            <td class="cursor-pointer" onclick="copyText('${acc.script_url}')" title="点击复制"><span class="text-truncate-cell">${acc.script_url || '-'}</span></td>
                            <td><span class="badge bg-secondary">${acc.type}</span></td>
                            <td>${statusSwitch}</td>
                            <td>
                                <button class="btn btn-sm btn-light text-primary py-0" onclick="openEditModal(${acc.id})"><i class="fas fa-edit"></i></button> 
                                <button class="btn btn-sm btn-light text-danger py-0" onclick="delAccount(${acc.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                        
                        // Datalist 选项
                        optionsHtml += `<option value="${acc.name}">别名: ${acc.alias || '-'}</option>`;
                    });
                    
                    $("#account-list-body").html(html);
                    $("#account-list-options").html(optionsHtml);
                });
        }

        function batchDelAccounts() {
            const ids = $(".acc-check:checked").map(function(){return this.value;}).get();
            if(ids.length === 0) return showToast("请先选择");
            if(confirm("确定删除选中邮箱?")) {
                fetch(API_BASE + '/api/accounts?ids=' + ids.join(','), { method: 'DELETE', headers: getHeaders() })
                    .then(() => { showToast("删除成功"); loadAccounts(); });
            }
        }

        function exportAccounts() {
             const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cachedAccounts, null, 2));
             const downloadAnchorNode = document.createElement('a');
             downloadAnchorNode.setAttribute("href", dataStr);
             downloadAnchorNode.setAttribute("download", "accounts_backup.json");
             document.body.appendChild(downloadAnchorNode);
             downloadAnchorNode.click();
             downloadAnchorNode.remove();
        }

        function importAccountsFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    fetch(API_BASE + '/api/accounts', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify(json)
                    }).then(r => r.json()).then(res => {
                        showToast(`导入成功 ${res.count || ''} 条`);
                        loadAccounts();
                    });
                } catch(err) {
                    showToast("文件格式错误");
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        // --- 任务管理 ---
        function getExecutionMode() {
            if ($("#pref-api").is(":checked")) return 'API';
            if ($("#pref-gas").is(":checked")) return 'GAS';
            return 'AUTO';
        }

        function saveTask() {
            const id = $("#edit-task-id").val();
            const accId = getSelectedAccountId();
            
            if (!accId) { showToast("请填写正确的发件邮箱名称"); return; }

            const data = {
                account_id: accId,
                to_email: $("#send-to").val(),
                subject: $("#send-subject").val(),
                content: $("#send-content").val(),
                base_date: $("#date-a").val(),
                delay_config: $("#range-b").val(),
                is_loop: $("#loop-switch").is(":checked"),
                execution_mode: getExecutionMode()
            };

            const method = id ? 'PUT' : 'POST';
            if(id) data.id = id;

            fetch(API_BASE + '/api/tasks', {
                method: method,
                headers: getHeaders(),
                body: JSON.stringify(data)
            }).then(() => {
                showToast(id ? "修改成功" : "添加成功");
                cancelEditTask();
                loadTasks();
            });
        }

        function sendNow() {
            const accId = getSelectedAccountId();
            if(!accId) { showToast("请填写正确的发件邮箱名称"); return; }

            const data = {
                account_id: accId,
                to_email: $("#send-to").val(),
                subject: $("#send-subject").val(),
                content: $("#send-content").val(),
                immediate: true,
                execution_mode: getExecutionMode()
            };
            
            const btn = $(event.target).closest('button');
            const originalHtml = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 发送中...');
            
            fetch(API_BASE + '/api/tasks', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(res => {
                btn.prop('disabled', false).html(originalHtml);
                if(res.ok) showToast("发送成功");
                else showToast("失败: " + (res.error || '未知'));
            })
            .catch(() => {
                btn.prop('disabled', false).html(originalHtml);
                showToast("网络错误");
            });
        }

        function loadTasks() {
            fetch(API_BASE + '/api/tasks', { headers: getHeaders() })
                .then(r => r.json())
                .then(data => {
                    cachedTasks = data;
                    let html = '';
                    data.forEach(task => {
                        let statusColor = task.status === 'success' ? 'text-success' : (task.status === 'error' ? 'text-danger' : 'text-warning');
                        
                        // 邮箱名匹配
                        const acc = cachedAccounts.find(a => a.id == task.account_id);
                        const accName = acc ? acc.name : `<span class="text-muted">ID:${task.account_id} (已删)</span>`;

                        // 循环开关
                        const loopSwitch = `
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" ${task.is_loop ? 'checked' : ''} onchange="toggleTaskLoop(${task.id}, this.checked)">
                        </div>`;
                        
                        html += `<tr>
                            <td><input type="checkbox" class="task-check" value="${task.id}"></td>
                            <td>${accName}</td>
                            <td><span class="text-truncate-cell" title="${task.subject||''}">${task.subject || '-'}</span></td>
                            <td>${new Date(task.next_run_at).toLocaleString()}</td>
                            <td>${loopSwitch}</td>
                            <td class="${statusColor}">${task.status}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary py-0" title="执行" onclick="manualRun(${task.id})"><i class="fas fa-play"></i></button>
                                <button class="btn btn-sm btn-outline-secondary py-0" title="编辑" onclick="editTask(${task.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger py-0" title="删除" onclick="delTask(${task.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    $("#task-list-body").html(html);
                });
        }

        function editTask(id) {
            const task = cachedTasks.find(t => t.id === id);
            if(!task) return;
            
            $("#edit-task-id").val(task.id);
            
            // Input 回显
            const acc = cachedAccounts.find(a => a.id == task.account_id);
            $("#send-account-input").val(acc ? acc.name : '');
            
            $("#send-to").val(task.to_email);
            $("#send-subject").val(task.subject);
            $("#send-content").val(task.content);
            $("#date-a").val(task.base_date ? new Date(task.base_date).toISOString().slice(0,16) : '');
            $("#range-b").val(task.delay_config);
            $("#loop-switch").prop("checked", !!task.is_loop);
            
            let mode = task.execution_mode || 'AUTO';
            $(`input[name="pref-mode"][id="pref-${mode.toLowerCase()}"]`).prop("checked", true);

            $("#task-card-title").text("编辑任务 (ID: " + id + ")");
            $("#btn-save-task").html('<i class="fas fa-save"></i> 更新任务');
            $("#btn-cancel-edit").removeClass("d-none");
            
            document.querySelector('.content-section.active').scrollIntoView();
        }

        function cancelEditTask() {
            $("#edit-task-id").val("");
            $("#task-card-title").text("创建任务 / 立即发送");
            $("#btn-save-task").html('<i class="fas fa-clock"></i> 添加任务');
            $("#btn-cancel-edit").addClass("d-none");
            
            $("#send-account-input").val("");
            $("#send-to").val("");
            $("#send-subject").val("");
            $("#send-content").val("");
        }

        function delTask(id) {
            if(confirm("确定删除任务?")) {
                fetch(API_BASE + '/api/tasks?id=' + id, { method: 'DELETE', headers: getHeaders() })
                    .then(() => { showToast("已删除"); loadTasks(); });
            }
        }
        
        function batchDelTasks() {
            const ids = $(".task-check:checked").map(function(){return this.value;}).get();
            if(ids.length === 0) return showToast("请先选择");
            if(confirm("确定删除选中任务?")) {
                fetch(API_BASE + '/api/tasks?ids=' + ids.join(','), { method: 'DELETE', headers: getHeaders() })
                    .then(() => { showToast("批量删除完成"); loadTasks(); });
            }
        }

        function manualRun(id) {
            if(!confirm("立即执行?")) return;
            fetch(API_BASE + '/api/tasks', {
                method: 'PUT',
                headers: getHeaders(),
                body: JSON.stringify({ id: id, action: 'execute' })
            }).then(r=>r.json()).then(res=>{
                if(res.ok) { showToast("执行成功"); loadTasks(); }
                else showToast("失败: "+res.error);
            });
        }

        function openBatchTaskModal() {
            new bootstrap.Modal(document.getElementById('batchTaskModal')).show();
        }
        
        function submitBatchTasks() {
            try {
                const json = JSON.parse($("#batch-task-json").val());
                if(!Array.isArray(json)) throw new Error("必须是数组");
                
                fetch(API_BASE + '/api/tasks', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(json)
                }).then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('batchTaskModal')).hide();
                    showToast("批量添加成功");
                    loadTasks();
                });
            } catch(e) {
                alert("JSON 格式错误: " + e.message);
            }
        }

        function toggleAll(type) {
            const checked = $("#check-all-" + type).is(":checked");
            $("." + type + "-check").prop("checked", checked);
        }

        // 辅助函数
        function openAddModal() {
            $("#accModalTitle").text("添加邮箱");
            $("#acc-id").val(""); 
            $("#acc-name").val("");
            $("#acc-alias").val("");
            $("#acc-script").val("");
            $("#acc-type").val("GAS");
            $("#acc-status").prop("checked", true);
            new bootstrap.Modal(document.getElementById('addAccountModal')).show();
        }
        function openEditModal(id) {
            const acc = cachedAccounts.find(a => a.id === id);
            if(!acc) return;
            $("#accModalTitle").text("编辑邮箱");
            $("#acc-id").val(acc.id);
            $("#acc-name").val(acc.name);
            $("#acc-alias").val(acc.alias);
            $("#acc-script").val(acc.script_url);
            $("#acc-type").val(acc.type);
            $("#acc-status").prop("checked", acc.status == 1);
            new bootstrap.Modal(document.getElementById('addAccountModal')).show();
        }
        function saveAccount() {
            const id = $("#acc-id").val();
            const data = {
                name: $("#acc-name").val(),
                alias: $("#acc-alias").val(),
                type: $("#acc-type").val(),
                script_url: $("#acc-script").val(),
                status: $("#acc-status").is(":checked")
            };
            const method = id ? 'PUT' : 'POST';
            if(id) data.id = id;
            fetch(API_BASE + '/api/accounts', { method, headers: getHeaders(), body: JSON.stringify(data) })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
                loadAccounts();
            });
        }
        function delAccount(id) {
            if(confirm("删除此邮箱?")) {
                fetch(API_BASE + '/api/accounts?id=' + id, { method: 'DELETE', headers: getHeaders() })
                    .then(loadAccounts);
            }
        }

        if(localStorage.getItem("auth_token")) {
            $("#login-overlay").hide();
            // 初始加载只加载账户，显示页面时按需加载
            loadAccounts();
        }
    </script>
</body>
</html>
